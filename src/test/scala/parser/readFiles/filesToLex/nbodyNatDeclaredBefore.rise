calcAcc::4xF32->4xF32->F32->F32->4xF32->4xF32
foreign calcAcc(p1,p2,deltaT, espSqr, acc){
   float4 r;
   r.xyz = p2.xyz - p1.xyz;
   float distSqr = r.x*r.x + r.y*r.y + r.z*r.z;
   float invDist = 1.0f / sqrt(distSqr + espSqr);
   float invDistCube = invDist * invDist * invDist;
   float s = invDistCube * p2.w;
   float4 res;
   res.xyz = acc.xyz + s * r.xyz;
   return res;
}
update::4xF32->4xF32->F32->4xF32->(4xF32,4xF32)
foreign update(pos, vel, deltaT, acceleration){
  float4 newPos;
  newPos.xyz = pos.xyz + vel.xyz * deltaT + 0.5f * acceleration.xyz * deltaT * deltaT;
  newPos.w = pos.w;
  float4 newVel;
  newVel.xyz = vel.xyz + acceleration.xyz * deltaT;
  newVel.w = vel.w;
  return (struct Record_float4_float4){ newPos, newVel };
}

tileX::NatTyp
tileX= 256N
tileY::NatTyp
tileY= 1N

nbody::N:Nat=>N.4xF32->N.4xF32->F32->F32->N.(4xF32,4xF32) --4xF32 for vec(4,f32)
nbody=\N:Nat=>\pos->\vel->\espSqr->\deltaT->
join . join .
   (mapWorkGroup 1

      join .
      (mapWorkGroup 0
        \p1Chunk ->
        \newP1Chunk->
        (mapLocal 1
          \bla->
          (mapLocal 0
            \p1A->
            update (fst (fst p1A)) (snd (fst p1A)) deltaT (snd p1A)
          )
          (zip newP1Chunk bla)).
          (oclReduceSeq Local

          (\accA->\p2A->
          let (toLocal (mapLocal 1 (mapLocal 0 (\x1->x1)) p2A))
           (
            \p2Local -> (mapLocal 1
              \accDim-> (mapLocal 0
                \p1B -> (oclReduceSeq Private
                  \accB->\p2B->
                  calcAcc (fst (fst p1B)) p2B deltaT espSqr accB
                ) (snd p1B) (fst accDim)
              ) (zip newP1Chunk (snd accDim))
            ) (zip p2Local accA)
          )

          )(mapLocal 1 (mapLocal 0 (\x2->x2)) (generate \plh1-> generate \plh2->vectorFromScalar 0F32)))--N.N.4xF32
          . (split tileY). ( split tileX ) pos--(N/256).1.256.4xF32
        (zip(toLocal(mapLocal 0 (\x3->x3) (fst (unzip p1Chunk))))(snd (unzip p1Chunk)))--zip(toLocal(mapLocal(id)(unzip(p1Chunk)._1)))(unzip(p1Chunk)._2)
        ). (split tileX)
      ). (split N) ( zip pos vel)